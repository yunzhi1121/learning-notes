# 锁

## 为什么需要锁？

**解决并发下的原子性、可见性、有序性问题**

### 原子性

一个操作或多个操作要么全执行，要么全不执行，不能被打断。

* 要保证以下 **原子性主体** 的原子性：
  * Java - 线程
  * MySQL - 事务
  * Redis - 分布式环境下的服务实例

但同时原子性还体现在 **单个主体** & **多个主体** 上：
- Java
  * 单个变量的修改（如 `i++`）；
  * 多步逻辑（如 `“读余额→减余额”`）

* MySQL
  * 单条 SQL（如 `UPDATE stock SET num=num-1`）；
  * 多条 SQL（如 `“扣库存 + 写订单”`）	

* Redis
    * 单条 Redis 命令（如 `DECR stock`）；
    * 多步 Redis 操作（如 `“GET stock→SET stock”`）

### 可见性

一个操作者修改的资源，其他操作者能及时看到



## 悲观锁 vs 乐观锁

**两种锁的核心差异在于 “对并发冲突的预判”，选择依据是冲突概率高低**
